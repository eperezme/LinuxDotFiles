/*******************************************************
* Copyright (C) 2018-2022 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";const e="Service_Background",n="Popup",t="Content_Script";const o=chrome.runtime.id,s=[".hotstar.",".hbogola.",".hboespana.","apps.disneyplus."],r=[".netflix.",".disneyplus.",".hbomax.",".hulu.",".amazon.",".primevideo.",".crunchyroll.",".youtube.",".espn.",".paramountplus."],i="https://redirect.teleparty.com",c=i,u="Failed to read chrome storage. Please refresh the page and try again",a="An unexpected error occured. Please refresh the page and try again.";class d{constructor(e,n,t,o,s){this.requiredPermissions=e,this.serverName=t,this.name=o,this.contentScripts=n,this.syncFromEnd=s}urlWithSessionId(e){return`${c}/join/${e}`}}var l,p;!function(e){e.NETFLIX="Netflix",e.HULU="Hulu",e.DISNEY_PLUS="Disney",e.HBO_MAX="HBOMax",e.YOUTUBE="Youtube",e.YOUTUBE_TV="YoutubeTV",e.AMAZON="Amazon",e.CRUNCHYROLL="Crunchyroll",e.ESPN="ESPN+",e.PARAMOUNT="Paramount+"}(l||(l={})),function(e){e.EPISODE="episode",e.FEATURE="feature",e.LIVE="live",e.EXTRA="extra",e.OTHER="other"}(p||(p={}));function h(e){return e.includes("urn:hbo:feature")?p.FEATURE:e.includes("urn:hbo:episode")||e.includes("urn:hbo:page:")&&e.includes(":type:episode")?p.EPISODE:e.includes("urn:hbo:extra")?p.EXTRA:p.OTHER}function m(e,n,t){const o="?"+e.split("?")[t];if(void 0===o)return;const s=n.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),r=new RegExp("[?|&]"+s+"=([^&]*)(&|$)").exec(o);return null===r||r.length<2?void 0:decodeURIComponent(r[1])}const w=new class extends d{isValidUrl(e){return function(e){return e.hostname.includes(".netflix.")&&e.pathname.includes("/watch")}(e)}isBrowsing(e){return e.hostname.includes(".netflix.")}getVideoId(e){const n=e.pathname.match(/^.*\/([0-9]+)\??.*/);return n&&n.length>0?n[1]:void 0}getFullscreenScript(){return'\n            (function() {\n                var sizingWrapper = document.getElementsByClassName("sizing-wrapper")[0];\n                    if (sizingWrapper) {\n                        sizingWrapper.requestFullscreen = function() {}\n                        document.getElementsByClassName(\'button-nfplayerFullscreen\')[0].onclick = function() {\n                            var fullScreenWrapper = document.getElementsByClassName("nf-kb-nav-wrapper")[0];\n                            fullScreenWrapper.webkitRequestFullScreen(fullScreenWrapper.ALLOW_KEYBOARD_INPUT);\n                        }\n                    }\n            })();\n        '}}([],["content_scripts/netflix/netflix_content_bundled.js"],"netflix",l.NETFLIX,!1);Object.freeze(w);const f=w;const v=new class extends d{isValidUrl(e){return function(e){return e.hostname.includes(".hulu.")&&e.pathname.includes("/watch")}(e)}isBrowsing(e){return e.hostname.includes(".hulu.")}getVideoId(e){const n=e.pathname.match(/^.*\/([a-z\-0-9]+)\??.*/);return n&&n.length>0?n[1]:void 0}}([],["content_scripts/hulu/hulu_content_bundled.js"],"hulu",l.HULU,!1);Object.freeze(v);const y=v;const g=new class extends d{isValidUrl(e){return function(e){return e.hostname.includes(".disneyplus.")&&e.pathname.includes("/video")}(e)}isBrowsing(e){return e.hostname.includes(".disneyplus.")}getVideoId(e){const n=e.pathname.match(/^.*\/([a-z\-0-9]+)\??.*/);return n&&n.length>0?n[1]:void 0}}([],["content_scripts/disney/disney_content_bundled.js"],"disney",l.DISNEY_PLUS,!1);Object.freeze(g);const b=g;const _=new class extends d{isValidUrl(e){return function(e){return e.hostname.includes(".hbomax.")&&"other"!==h(e.pathname)||e.pathname.includes("urn:hbo:page")}(e)}isBrowsing(e){return e.hostname.includes(".hbomax.")}getVideoId(e){const n="urn:hbo:"+h(e.pathname)+":",t=e.pathname.split(n);let o=null!=t&&t.length>1&&null!=t[1]?t[1].match(/^([a-zA-Z\-_0-9]+)\??.*/):null;const s=null!=o&&0!==o.length?t[1].match(/^([a-zA-Z\-_0-9]+)\??.*/):void 0;let r=s&&s.length>0?s[1]:void 0;return r||(o=e.pathname.match(/(page:)([a-zA-Z\-_0-9]+)\??.*/),r=null!=o&&3==o.length?o[2]:void 0),r}getVideoType(e){return h(e.pathname)}}([],["content_scripts/hbo_max/hbo_max_content_bundled.js"],"hbomax",l.HBO_MAX,!1);Object.freeze(_);const x=_;const k=new class extends d{isValidUrl(e){return function(e){return e.hostname.includes(".amazon.")||e.hostname.includes(".primevideo.")}(e)}isBrowsing(e){return!1}getVideoId(e){const n=e.pathname.split("ref")[0].match(/^.*\/([a-z\-0-9.A-Z]+)(\?|\/ref)?.*/);return null!=n&&n.length>0?n[1]:void 0}}([],["content_scripts/amazon/amazon_content_bundled.js"],"amazon",l.AMAZON,!1);Object.freeze(k);const S=k;const P=new class extends d{isBrowsing(e){return e.hostname.includes(".crunchyroll.")}isValidUrl(e){return function(e){return e.hostname.includes(".crunchyroll.")}(e)}getVideoId(e){const n=e.pathname.match(/watch\/(.*)\//);return n&&n.length>0?n[1]:void 0}}([],["content_scripts/crunchyroll/crunchyroll_content_bundled.js"],"crunchyroll",l.CRUNCHYROLL,!1);Object.freeze(P);const j=P;const T=new class extends d{isBrowsing(e){return!!e.href.includes("watch?")}isValidUrl(e){return function(e){return!(e.hostname.includes("tv.youtube.com")&&!e.pathname.includes("/watch"))&&e.hostname.includes(".youtube.")}(e)}getVideoId(e){if(e.href.includes("/watch")||e.href.includes("/shorts/")){const n=/(youtu.*be.*)\/(watch\?v=|embed\/|v|shorts|)(.*?((?=[&#?])|$))/gm.exec(e.href);return null!=n&&n.length>3&&n[3]?n[3]:void 0}return"browsing"}}([],["content_scripts/youtube/youtube_content_bundled.js"],"youtube",l.YOUTUBE,!1);Object.freeze(T);const I=T;const V=new class extends d{isBrowsing(e){return e.hostname.includes(".espn.")}isValidUrl(e){return function(e){return e.hostname.includes(".espn.")&&e.pathname.includes("/player")}(e)}getVideoId(e){const n=e.pathname;return n.substring(n.lastIndexOf("/")+1)}}([],["content_scripts/espn/espn_content_bundled.js"],"espn",l.ESPN,!1);Object.freeze(V);const A=V;const E=new class extends d{isBrowsing(e){return e.hostname.includes(".paramountplus.")}isValidUrl(e){return function(e){return e.hostname.includes(".paramountplus.")&&e.pathname.includes("/video")}(e)}getVideoId(e){const n=e.pathname.match(/([^/]+)\/?$/);return n&&n.length>0?n[1]:void 0}}([],["content_scripts/paramount/paramount_content_bundled.js"],"paramount",l.PARAMOUNT,!1);Object.freeze(E);const O=E;class z{constructor(e,n){var t;this.isBrowsing=!1,this.id=n,this.videoId,this.url=e;const o=[f,y,b,x,S,I,j,A,O];for(const n of o){if(n.isValidUrl(this.url)){this.streamingService=n,this.serviceName=n.name,this.videoId=n.getVideoId(e);break}if(n.isBrowsing(this.url)){this.isBrowsing=!0,this.streamingService=n,this.serviceName=n.name;break}}this.sessionIdFromUrl=null!==(t=m(this.url.href,"npSessionId",1))&&void 0!==t?t:void 0}urlWithSessionId(e){return this.streamingService?this.streamingService.urlWithSessionId(e):void 0}}var U;!function(e){e.CREATE_SESSION="createSession",e.RE_INJECT="reInject",e.GET_INIT_DATA="getInitData",e.GET_INIT_USER_SESTTINGS="getInitUserSettings",e.IS_CONTENT_SCRIPT_READY="isContentScriptReady",e.SET_CHAT_VISIBLE="setChatVisible",e.DISCONNECT="teardown",e.CLOSE_POPUP="closePopup",e.GET_SCHEDULED_EVENTS="getScheduledEvents",e.GET_RECENT_SCHEDULED_EVENTS="getRecentScheduledEvents",e.GOOGLE_SIGN_IN="googleSignIn",e.CREATE_SCHEDULED_EVENT="createScheduledEvent",e.DELETE_SCHEDULED_EVENT="deleteScheduledEvent",e.SET_USER_STATUS="SET_USER_STATUS"}(U||(U={}));class C{constructor(e,n,t){this.sender=e,this.target=n,this.type=t}}class N extends C{constructor(e,n,t){super(e,n,t),this.type=t}}class B extends N{constructor(e,n,t){super(e,n,U.CREATE_SESSION),this.data=t}}var W=console.log.bind(window.console);const D=new class{addListener(e){chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}sendMessageToTabAsync(e,n,t=2e4){return new Promise(((o,s)=>{const r=setTimeout((()=>{s()}),t);try{chrome.tabs.sendMessage(n,e,(n=>{chrome.runtime.lastError&&W(chrome.runtime.lastError.message+JSON.stringify(e)),clearTimeout(r),o(n)}))}catch(e){clearTimeout(r),s(e)}}))}t(e,n){return new Promise(((t,s)=>{let r=null;n&&(r=setTimeout((()=>{s({error:"Send Message Timeout"})}),n));try{chrome.runtime.sendMessage(o,e,(n=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(e)),r&&clearTimeout(r),t(n)}))}catch(e){r&&clearTimeout(r),s(e)}}))}};class R extends N{constructor(e,n){super(e,n,U.GET_INIT_DATA)}}class L extends N{constructor(e,n){super(e,n,U.IS_CONTENT_SCRIPT_READY)}}class $ extends N{constructor(e,n,t){super(e,n,U.SET_CHAT_VISIBLE),this.data=t}}class q extends C{constructor(e,n,t){super(e,n,t),this.type=t}}var F;!function(e){e.JOIN_SESSION="joinSession",e.ACCEPT_DROPIN="acceptDropin",e.SET_STATUS_TYPE="setStatusType",e.GET_STATUS_TYPE="getStatusType",e.GET_VIDEO_DATA="getVideoData",e.LOAD_SESSION="loadSession",e.NO_SESSION_DATA="noSessionData",e.ON_NOTIF="onNotif",e.FORWARD_TO_SIDEBAR="forwardToSidebar",e.TEARDOWN="teardown",e.ON_VIDEO_UPDATE="onVideoUpdate",e.SOCKET_LOST_CONNECTION="socketLostConnection",e.REBOOT="socketReconnect",e.LOG_EVENT="logEvent",e.LOG_EXPERIMENT="logExpirement",e.STAY_ALIVE="stayAlive",e.LOAD_CHAT_WINDOW="loadChatWindow",e.RESET_CHAT_WINDOW="resetChatWindow",e.HIDE_CHAT_WINDOW="hideChatWindow",e.SET_USER_PRESENCE="setUserPresence",e.TOGGLE_OPEN_PARTY="toggleOpenParty",e.GET_ACTIVE_PARTY="getActiveParty",e.GET_TAB_ID="getTabId",e.SET_ACTIVE_PARTY="setActiveParty",e.FULLSCREEN_WINDOW="fullscreenWindow",e.MAX_WINDOW="maxWindow"}(F||(F={}));class M extends q{constructor(e,n,t){super(e,n,F.LOG_EVENT),this.data=t,this.sender=e,this.target=n}}class J extends N{constructor(e,n){super(e,n,U.DISCONNECT)}}const Z={$6:["*://*/*"]};class H extends q{constructor(e,n,t){super(e,n,F.LOG_EXPERIMENT),this.data=t}}var Y=function(e,n,t,o){return new(t||(t=Promise))((function(s,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,c)}u((o=o.apply(e,n||[])).next())}))};const K=new class{setItemsAsync(e){return Y(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?t(new Error("Failed to write to chrome storage. Please refresh the page and try again")):n()}))}))}))}};Object.freeze(K);const Q=K;var X=function(e,n,t,o){return new(t||(t=Promise))((function(s,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,c)}u((o=o.apply(e,n||[])).next())}))};const G=new class{getItemsAsync(e){return X(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?t(new Error(u)):n(e)}))}))}))}getAllItemsAsync(){return X(this,void 0,void 0,(function*(){return new Promise(((e,n)=>{chrome.storage.local.get(null,(t=>{chrome.runtime.lastError?n(new Error(u)):e(t)}))}))}))}};Object.freeze(G);const ee=G,ne="create-session-clickedchrome";var te=function(e,n,t,o){return new(t||(t=Promise))((function(s,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,c)}u((o=o.apply(e,n||[])).next())}))};const oe=[];let se;oe.push(["_setAccount","UA-71812070-2"]),oe.push(["_trackPageview"]),function(){var e;const n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://ssl.google-analytics.com/ga.js";const t=document.getElementsByTagName("script")[0];null===(e=t.parentNode)||void 0===e||e.insertBefore(n,t)}(),console.log("Popup Loaded"),function(){const t=new M(n,e,{name:"user_click",component:{name:"popup_open",type:"button",origin:"tp"}});D.t(t);const o=new M(n,e,{eventType:"popup-open-chrome"});D.t(o)}(),chrome.runtime.onUpdateAvailable.addListener((function(e){oe.push(["_trackEvent","auto-update ->"+e.version,"clicked"]),chrome.runtime.reload()})),chrome.storage.local.get(["userId"],(function(e){e.userId&&(se=e.userId)}));const re=jQuery;function ie(t,o=!0){const s=new M(n,e,{name:"error",action:{reason:t,description:"An error has occured"}});D.t(s),re(".some-error").removeClass("hidden"),re(".no-error").addClass("hidden"),re("#error-msg").html(t),o?re("#close-error").removeClass("hidden"):re("#close-error").addClass("hidden")}function ce(){re("#control-lock").prop("disabled",!0),re("#create-session").prop("disabled",!0),re("#leave-session").prop("disabled",!0),re("#create-session").html('Loading <span class="ellipsis-anim"><span>.</span><span>.</span><span>.</span></span>')}function ue(){re("#control-lock").prop("disabled",!1),re("#create-session").prop("disabled",!1),re("#leave-session").prop("disabled",!1),re("#create-session").text("Start the party")}re((function(){ce(),function(){return te(this,void 0,void 0,(function*(){return new Promise(((e,n)=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){if(t.length>0){const n=t[0];if(n.id&&n.url)return void e({id:n.id,url:n.url})}n()}))}))}))}().then((o=>{let i;if(W("Setting up popup event listeners"),re("#create-session").click(f),re("#close-error").click(v),re("#reviewLink").click(y),re("#learn-more").click(_),re("#learn-more-teleparty").click(x),re("#leave-session").click(k),re("#show-chat").change(S),re("#share-url").click(b),re("#copy-btn").click(g),re("#service-netflix").on("click",p(l.NETFLIX)),re("#service-hulu").on("click",p(l.HULU)),re("#service-amazon").on("click",p(l.AMAZON)),re("#service-hbomax").on("click",p(l.HBO_MAX)),re("#service-disney").on("click",p(l.DISNEY_PLUS)),re("#service-youtube").on("click",p(l.YOUTUBE)),re("#service-youtube-tv").on("click",p(l.YOUTUBE_TV)),!o.url||!o.id)return re(".wrongSite").removeClass("hidden"),void re(".disconnected").addClass("hidden");{const c=new URL(o.url);if(i=new z(c,o.id),!i.serviceName)return!function(e){return s.some((n=>e.hostname.includes(n)))}(c)?!function(e){return r.some((n=>e.hostname.includes(n)))}(c)?re(".wrongSite").removeClass("hidden"):re(".serviceSite").removeClass("hidden"):re(".unsupportedSite").removeClass("hidden"),void re(".disconnected").addClass("hidden");re(".permissions").addClass("hidden"),D.addListener((function(t,o,s){t.sender==e&&t.target==n&&t.type==U.CLOSE_POPUP&&(s(),window.close());return!1})),function(){return te(this,void 0,void 0,(function*(){if(i.streamingService){const e=i.streamingService;yield new Promise((e=>{chrome.tabs.executeScript(i.id,{file:"lib/tp_libraries_min.js"},e)})),yield Promise.all(e.contentScripts.map((e=>new Promise((n=>{chrome.tabs.executeScript(i.id,{file:e},(()=>{n()}))}))))),console.log("Content Scripts ready")}}))}().then((function(){return te(this,void 0,void 0,(function*(){const e=new L(n,t),o=yield D.sendMessageToTabAsync(e,i.id);o?o.error?(ie(o.error.message,o.error.showButton),ue()):(ue(),function(){var e;te(this,void 0,void 0,(function*(){ce();const o=new R(n,t),s=yield D.sendMessageToTabAsync(o,i.id);s.inSession&&s.partyUrl&&(d(s.partyUrl),re(".popup-showchat-container").show(),re("#show-chat").prop("checked",null!==(e=s.isChatVisible)&&void 0!==e&&e),s.showReviewMessage),ue()}))}(),W("Content Script Ready")):(ie(a,!1),ue())}))}))}function u(e){e&&e.error?ie(e.error,!1):ie(a,!1)}function d(e){re(".disconnected").addClass("hidden"),re(".connected").removeClass("hidden"),re("#show-chat").prop("checked",!0),re("#share-url").val(e).focus().select()}function p(t){return()=>{const o=new M(n,e,{name:"user_click",action:{description:`popup_service-btn_${t}`}});switch(D.t(o),t){case l.NETFLIX:window.open("https://netflix.com");break;case l.DISNEY_PLUS:window.open("https://disneyplus.com");break;case l.AMAZON:window.open("https://www.amazon.com/Prime-Video/b?node=2676882011");break;case l.HBO_MAX:window.open("https://hbomax.com");break;case l.HULU:window.open("https://hulu.com");break;case l.YOUTUBE:window.open("https://www.youtube.com");break;case l.YOUTUBE_TV:window.open("https://tv.youtube.com")}}}function h(){return te(this,void 0,void 0,(function*(){const t=(yield ee.getItemsAsync(["popupPermissionsRequestedDate"])).popupPermissionsRequestedDate;if(t)try{if(function(e){const n=new Date;return n.setHours(0,0,0,0),Math.abs(Number(n)-Number(e))<=3024e5}(new Date(t)))return void w()}catch(e){}return Q.setItemsAsync({popupPermissionsRequestedDate:(new Date).toString()}),new Promise((t=>{chrome.permissions.contains({origins:Z.$6},(o=>{if(o)w(),t(!0);else{re(".disconnected").addClass("hidden"),re(".permissions").removeClass("hidden");let o=!1;re("#accept-permissions").click((()=>{o||(o=!0,chrome.permissions.request({origins:Z.$6},(o=>te(this,void 0,void 0,(function*(){const s="all_sites-popup-chrome",r=new H(n,e,{experimentName:"permissions_request",experimentVersion:s,eventType:"permissions-prompted"});D.t(r);const i=new H(n,e,{experimentName:"permissions_request",experimentVersion:s,eventType:o?"permissions-granted":"permissions-denied"});D.t(i,2500),re(".permissions").addClass("hidden"),re(".disconnected").removeClass("hidden"),yield w(),t(o)})))))}))}}))}))}))}function w(){return te(this,void 0,void 0,(function*(){W("Sending create session");const t=new B(n,e,{createSettings:{controlLock:re("#control-lock").is(":checked")},extensionTabData:i});try{const e=yield D.t(t);if(e&&e.sessionId){const n=e.sessionId,t=function(e){return`${c}/join/${e}`}(n);d(t),function(e){var n;oe.push(["_trackEvent","create-session","clicked",i.serviceName]),function(e,n,t){try{if(se){const o={userId:se,eventType:e,sessionId:n,serviceName:t};console.log("event: "+JSON.stringify(o));const s=new XMLHttpRequest;s.open("POST","https://data.f/log-event"),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(o))}}catch(e){console.log("log event error")}}("create-session",e,null!==(n=i.serviceName)&&void 0!==n?n:"")}(n)}else u(e);ue()}catch(e){ue(),u(e)}}))}function f(){return te(this,void 0,void 0,(function*(){!function(){const t=new M(n,e,{name:"user_click",component:{name:"popup-create_session",type:"button",origin:"tp"}});D.t(t);const o=new M(n,e,{eventType:ne});D.t(o)}(),ce(),yield h()}))}function v(){re(".no-error").removeClass("hidden"),re(".some-error").addClass("hidden")}function y(){window.open("https://chrome.google.com/webstore/detail/netflix-party-is-now-tele/oocalimimngaihdkbihfgmpkcpnmlaoa/reviews"),chrome.storage.local.set({reviewClicked:!0});const t=new M(n,e,{name:"review-clicked",action:{description:"review link was clicked"}});D.t(t);const o=new M(n,e,{eventType:"review-clicked-chrome"});D.t(o)}function g(e){console.log("click");const n=m(re("#share-url").val(),"npSessionId",1);n&&d(n),e.stopPropagation(),e.preventDefault(),re("#share-url").select(),document.execCommand("copy"),re("#copy-btn").parent().css("background","#24D154"),re("#copy-btn").text("Copied!")}function b(e){e.stopPropagation(),e.preventDefault(),re("#share-url").select()}function _(){chrome.tabs.create({url:"https://www.netflixparty.com/support"})}function x(){chrome.tabs.create({url:"https://www.netflixparty.com/introducing-teleparty"})}function k(){return te(this,void 0,void 0,(function*(){const o=new M(n,e,{name:"user_click",component:{name:"popup-disconnect_session",type:"button",origin:"tp"}});D.t(o);const s=new J(n,t);yield D.sendMessageToTabAsync(s,i.id),window.close()}))}function S(){const e={visible:re("#show-chat").is(":checked")},o=new $(n,t,e);D.sendMessageToTabAsync(o,i.id)}re("#reviewLink").attr("href","https://chrome.google.com/webstore/detail/netflix-party-is-now-tele/oocalimimngaihdkbihfgmpkcpnmlaoa/reviews")})).catch((e=>{console.log(e)}))}))})();